<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü™ê Astro-Agent | Self-Healing IDE</title>
    
    <style>
        :root { 
            --bg: #0d1117; --panel: #161b22; --border: #30363d; 
            --text: #c9d1d9; --accent: #238636; --danger: #da3633; --warn: #d29922;
            --font-ui: 'Segoe UI', sans-serif; --font-code: 'Consolas', monospace;
        }
        body { background: var(--bg); color: var(--text); font-family: var(--font-ui); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; align-items: center; }
        * { box-sizing: border-box; }

        .container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; gap: 20px; height: 100%; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .header h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .badge { font-size: 0.8rem; background: var(--panel); padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border); color: #8b949e; }
        .badge.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Grid */
        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; flex: 1; min-height: 0; }
        
        /* Controls (Left) */
        .control-panel { display: flex; flex-direction: column; gap: 15px; }
        .dataset-info { background: var(--panel); padding: 12px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.85rem; }
        .input-group { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        textarea { flex: 1; background: #010409; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 6px; resize: none; font-family: var(--font-code); }
        textarea:focus { outline: 1px solid var(--accent); }
        
        button.btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button.btn-primary:hover { opacity: 0.9; }
        button.btn-primary:disabled { background: var(--panel); color: #8b949e; cursor: not-allowed; opacity: 0.6; }

        /* Outputs (Right) */
        .output-panel { display: flex; flex-direction: column; background: var(--panel); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .tabs { display: flex; background: #21262d; border-bottom: 1px solid var(--border); }
        .tab { padding: 10px 20px; cursor: pointer; color: #8b949e; background: none; border: none; border-right: 1px solid var(--border); font-size: 0.9rem; }
        .tab:hover { background: var(--border); color: white; }
        .tab.active { background: var(--panel); color: white; border-top: 3px solid var(--accent); font-weight: bold; }

        .view { flex: 1; display: none; overflow: auto; position: relative; }
        .view.active { display: block; }
        
        /* Logs */
        .console { padding: 15px; font-family: var(--font-code); font-size: 0.85rem; line-height: 1.4; }
        .log-sys { color: #58a6ff; }
        .log-ai { color: #f1e05a; }
        .log-err { color: var(--danger); }
        .log-warn { color: var(--warn); }
        .log-ok { color: var(--accent); }
        .log-step { border-top: 1px dashed var(--border); margin-top: 8px; padding-top: 8px; color: #8b949e; display:block; }

        /* Code & Plot */
        pre { margin: 0; padding: 15px; }
        code { color: #d2a8ff; font-family: var(--font-code); }
        #plot-target { display: flex; justify-content: center; align-items: center; height: 100%; background: white; color: black; }
        button.matplotlib-toolbar-button { 
            display: none !important; 
        }
        
        /* On cache aussi les textes (comme "pdf", "png") qui pourraient tra√Æner √† c√¥t√© */
        #plot-target span {
            /* Attention : cela cible tous les spans dans le plot, 
               mais matplotlib met le graphique dans un canvas ou div, 
               donc le span de la toolbar est g√©n√©ralement le seul √† ce niveau */
            display: none !important; 
        }
        
        /* On s'assure que le canvas (le graphique) reste visible */
        #plot-target canvas, #plot-target div {
            display: block !important;
        }
</style>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";
        window.webllm = webllm;
    </script>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ü™ê Astro-Agent <span style="font-size:0.5em; color:#8b949e; margin-left:10px;">// Platform Engineering Demo</span></h1>
        <div id="statusBadge" class="badge">‚ö° Chargement...</div>
    </div>

    <div class="main-grid">
        <div class="control-panel">
            <div class="dataset-info">
                <strong>üìä Dataset :</strong> planets.csv<br>
                <code style="color:#8b949e">method, number, orbital_period, mass, distance, year</code>
            </div>
            
            <div class="input-group">
                <label>ü§ñ <b>Instruction</b></label>
                <textarea id="userPrompt">Calcule la moyenne de la colonne 'mass' et trace un histogramme.</textarea>
            </div>
            
            <button id="runBtn" class="btn-primary" onclick="app.runAgent()" disabled>
                üöÄ Lancer le Pipeline
            </button>
            <div style="text-align:center; font-size:0.7rem; color:#8b949e;">Pyodide (WASM) & WebLLM (WebGPU)</div>
        </div>

        <div class="output-panel">
            <div class="tabs">
                <button class="tab active" onclick="ui.switchTab('logs')">üìã Console Ops</button>
                <button class="tab" onclick="ui.switchTab('code')">üêç Code Audit</button>
                <button class="tab" onclick="ui.switchTab('plot')">üìä Visualisation</button>
            </div>

            <div id="view-logs" class="view active">
                <div id="consoleOutput" class="console"></div>
            </div>

            <div id="view-code" class="view" style="background:#0d1117;">
                <pre><code id="codeViewer"># Le code g√©n√©r√© appara√Ætra ici...</code></pre>
            </div>

            <div id="view-plot" class="view">
                <div id="plot-target"><span style="opacity:0.5"></span></div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. CONFIG & STATE
    // ==========================================
    const CONFIG = {
        modelId: "Qwen2.5-Coder-7B-Instruct-q4f32_1-MLC",
        csvUrl: "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/planets.csv"
    };
    let state = { pyodide: null, engine: null, isReady: false };

    // ==========================================
    // 2. UI MANAGER
    // ==========================================
    const ui = {
        refs: {
            out: document.getElementById('consoleOutput'),
            status: document.getElementById('statusBadge'),
            btn: document.getElementById('runBtn'),
            plot: document.getElementById('plot-target'),
            code: document.getElementById('codeViewer')
        },
        log: (msg, type="INFO") => {
            const map = { AI: "log-ai", ERROR: "log-err", SUCCESS: "log-ok", STEP: "log-step", WARN: "log-warn", SYS: "log-sys" };
            const time = new Date().toLocaleTimeString();
            ui.refs.out.innerHTML += `<div class="${map[type] || ''}">[${time}] ${msg}</div>`;
            ui.refs.out.scrollTop = ui.refs.out.scrollHeight;
        },
        setStatus: (msg, ready=false) => {
            ui.refs.status.innerText = msg;
            if(ready) ui.refs.status.classList.add('active');
        },
        switchTab: (tabName) => {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            // Simple mapping for demo
            const idx = ['logs', 'code', 'plot'].indexOf(tabName);
            if(idx > -1) document.querySelectorAll('.tab')[idx].classList.add('active');
        }
    };

    // ==========================================
    // 3. CORE LOGIC (L'AGENT & LA BOUCLE)
    // ==========================================
    const app = {
        init: async () => {
            try {
                ui.log("Initialisation Python WASM...", "SYS");
                state.pyodide = await loadPyodide();
                await state.pyodide.loadPackage(["pandas", "matplotlib"]);
                
                ui.log("T√©l√©chargement Data...", "SYS");
                const csv = await (await fetch(CONFIG.csvUrl)).text();
                state.pyodide.FS.writeFile("planets.csv", csv);

                ui.log("Chargement du Mod√®le (WebGPU)...", "SYS");
                const { MLCEngine } = window.webllm;
                state.engine = new MLCEngine();
                state.engine.setInitProgressCallback((r) => ui.setStatus(`‚è≥ ${r.text}`));
                await state.engine.reload(CONFIG.modelId);
                
                state.isReady = true;
                ui.setStatus("‚úÖ Syst√®me Pr√™t", true);
                ui.refs.btn.disabled = false;
                ui.log("Agent pr√™t.", "SUCCESS");

            } catch (e) { ui.log(`CRASH INIT: ${e.message}`, "ERROR"); }
        },

        runAgent: async () => {
            if(!state.isReady) return;
            ui.switchTab('logs');
            ui.refs.btn.disabled = true;
            //ui.refs.plot.innerHTML = '<span style="opacity:0.5">G√©n√©ration...</span>';
            
            const prompt = document.getElementById('userPrompt').value;
            const maxRetries = 3;
            let attempt = 1;

            // --- CONTEXTE & MEMOIRE ---
            let messages = [
                { role: "system", content: `Tu es un Data Scientist Python expert.
                  CONTEXTE:
                  - Fichier: 'planets.csv'.
                  - Colonnes: method, number, orbital_period, mass, distance, year.
                  - Pas de colonne date, utilise 'year'.
                  
                  R√àGLES:
                  1. Code uniquement entre \`\`\`python ... \`\`\`.
                  2. Utilise pandas et matplotlib.
                  3. Pas de texte superflu.` 
                },
                { role: "user", content: prompt }
            ];

            ui.log("--- D√âMARRAGE PIPELINE ---", "STEP");

            // --- LA BOUCLE DE SELF-HEALING ---
            while (attempt <= maxRetries) {
                ui.log(`üîÑ Tentative ${attempt}/${maxRetries}...`, "STEP");

                try {
                    // 1. G√©n√©ration
                    ui.log("üß† G√©n√©ration du code...", "AI");
                    const reply = await state.engine.chat.completions.create({ messages });
                    const rawResponse = reply.choices[0].message.content;

                    // Extraction robuste du code
                    let cleanCode = rawResponse;
                    const match = rawResponse.match(/```(?:python)?([\s\S]*?)```/i);
                    if (match) cleanCode = match[1].trim();

                    ui.refs.code.innerText = cleanCode; // Mise √† jour Visuelle
                    ui.log("Code inject√© dans l'audit.", "SYS");

                    // 2. Ex√©cution Sandbox
                    ui.log("üõ°Ô∏è Ex√©cution s√©curis√©e...", "SYS");
                    const result = await sandbox.execute(cleanCode);

                    if (result.success) {
                        // --- SUCC√àS ---
                        ui.log("‚úÖ Code valid√© et ex√©cut√©.", "SUCCESS");
                        if(result.output) ui.log(`STDOUT: ${result.output}`, "INFO");
                        
                        // Check Graphique
                        if(ui.refs.plot.innerHTML.includes('<svg')) {
                            ui.log("üìä Graphique d√©tect√©. Bascule onglet.", "SUCCESS");
                            setTimeout(() => ui.switchTab('plot'), 1000);
                        }
                        break; // On sort de la boucle while
                    } else {
                        // --- ECHEC & FEEDBACK LOOP ---
                        ui.log(`üõë Erreur Runtime: ${result.error}`, "ERROR");
                        
                        if(attempt < maxRetries) {
                            ui.log("üîß Auto-correction : Envoi de l'erreur √† l'IA...", "WARN");
                            
                            // On nourrit l'historique de conversation
                            messages.push({ role: "assistant", content: rawResponse });
                            messages.push({ 
                                role: "user", 
                                content: `Ton code a plant√© avec l'erreur : "${result.error}". Corrige le code.` 
                            });
                        }
                        attempt++;
                    }
                } catch (fatal) {
                    ui.log(`Fatal JS Error: ${fatal}`, "ERROR");
                    break;
                }
            }

            if(attempt > maxRetries) ui.log("üíÄ Abandon apr√®s √©checs multiples.", "ERROR");
            ui.refs.btn.disabled = false;
        }
    };

    // ==========================================
    // 4. PYTHON SANDBOX
    // ==========================================
    const sandbox = {
        execute: async (codeToRun) => {
            const wrapper = `
import ast, sys, io, json, js
import pandas as pd
import matplotlib.pyplot as plt

# On d√©sactive la toolbar matplotlib
plt.rcParams['toolbar'] = 'None' 

# Cible pour les plots
document = js.document
document.pyodideMplTarget = document.getElementById("plot-target")

# Politique de s√©curit√© simple
def check_safety(c):
    try:
        tree = ast.parse(c)
    except SyntaxError as e: return False, f"Syntax Error: {e}"
    for n in ast.walk(tree):
        if isinstance(n, (ast.Import, ast.ImportFrom)):
            mod = n.names[0].name if isinstance(n, ast.Import) else n.module
            if mod and mod.split('.')[0] in ['os', 'sys', 'subprocess']:
                return False, f"Import interdit: {mod}"
    return True, ""

code = '''${codeToRun.replace(/'/g, "\\'")}'''
is_safe, msg = check_safety(code)
res = {}

if not is_safe:
    res = {"success": False, "error": f"Security: {msg}", "output": ""}
else:
    old = sys.stdout
    capt = io.StringIO()
    sys.stdout = capt
    try:
        plt.clf()
        exec(code)
        if plt.get_fignums(): plt.show()
        res = {"success": True, "error": "", "output": capt.getvalue()}
    except Exception as e:
        res = {"success": False, "error": str(e), "output": ""}
    finally:
        sys.stdout = old

json.dumps(res)
            `;
            try {
                const jsonStr = await state.pyodide.runPythonAsync(wrapper);
                return JSON.parse(jsonStr);
            } catch(e) {
                return { success: false, error: "Pyodide Crash: " + e.message };
            }
        }
    };

    window.addEventListener('load', app.init);
</script>

</body>
</html>