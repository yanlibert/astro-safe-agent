<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü™ê Astro-Agent | Multi-Source Platform</title>
    
    <style>
        :root { 
            --bg: #0d1117; --panel: #161b22; --border: #30363d; 
            --text: #c9d1d9; --accent: #238636; --danger: #da3633; --warn: #d29922;
            --font-ui: 'Segoe UI', sans-serif; --font-code: 'Consolas', monospace;
        }
        body { background: var(--bg); color: var(--text); font-family: var(--font-ui); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; align-items: center; }
        * { box-sizing: border-box; }

        .container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; gap: 20px; height: 100%; }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .header h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .badge { font-size: 0.8rem; background: var(--panel); padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border); color: #8b949e; }
        .badge.active { background: var(--accent); color: white; border-color: var(--accent); }

        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; flex: 1; min-height: 0; }
        
        .control-panel { display: flex; flex-direction: column; gap: 15px; }
        
        /* DATASET CONFIGURATION */
        .dataset-config { background: var(--panel); padding: 12px; border-radius: 6px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        
        /* Style pour le Select et l'Input */
        select, input { background: #010409; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; width: 100%; font-family: var(--font-ui); font-size: 0.8rem; margin-bottom: 5px; }
        select:focus, input:focus { outline: 1px solid var(--accent); }
        
        .col-badge { display: inline-block; background: #21262d; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: #8b949e; margin: 2px; border: 1px solid var(--border); }

        .input-group { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        textarea { flex: 1; background: #010409; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 6px; resize: none; font-family: var(--font-code); }
        textarea:focus { outline: 1px solid var(--accent); }
        
        button.btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button.btn-primary:hover { opacity: 0.9; }
        button.btn-primary:disabled { background: var(--panel); color: #8b949e; cursor: not-allowed; opacity: 0.6; }
        button.btn-sm { padding: 5px 10px; font-size: 0.8rem; background: #21262d; border: 1px solid var(--border); color: white; cursor: pointer; border-radius: 4px; width: 100%; }
        button.btn-sm:hover { background: #30363d; }

        .output-panel { display: flex; flex-direction: column; background: var(--panel); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .tabs { display: flex; background: #21262d; border-bottom: 1px solid var(--border); }
        .tab { padding: 10px 20px; cursor: pointer; color: #8b949e; background: none; border: none; border-right: 1px solid var(--border); font-size: 0.9rem; }
        .tab:hover { background: var(--border); color: white; }
        .tab.active { background: var(--panel); color: white; border-top: 3px solid var(--accent); font-weight: bold; }

        .view { flex: 1; display: none; overflow: auto; position: relative; }
        .view.active { display: block; }
        
        .console { padding: 15px; font-family: var(--font-code); font-size: 0.85rem; line-height: 1.4; }
        .log-sys { color: #58a6ff; }
        .log-ai { color: #f1e05a; }
        .log-err { color: var(--danger); }
        .log-warn { color: var(--warn); }
        .log-ok { color: var(--accent); }
        .log-step { border-top: 1px dashed var(--border); margin-top: 8px; padding-top: 8px; color: #8b949e; display:block; }

        pre { margin: 0; padding: 15px; }
        code { color: #d2a8ff; font-family: var(--font-code); }
        
        #plot-target { display: flex; justify-content: center; align-items: center; height: 100%; background: white; color: black; position: relative; }
        .matplotlib-toolbar-button { display: none !important; }
        #plot-target > span { display: none !important; }
        #plot-target canvas { max-width: 95%; max-height: 95%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border-radius: 4px; }

        #plot-target canvas[id*="rubberband"] {    
            display: none !important;
        }
        /* S'assurer que le canvas principal reste propre */
        #plot-target canvas:not([id*="rubberband"]) {
            display: block !important;
            max-width: 100%;
            height: auto !important; /* Important pour √©viter la d√©formation */
        }
    </style>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";
        window.webllm = webllm;
    </script>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ü™ê Astro-Agent <span style="font-size:0.5em; color:#8b949e; margin-left:10px;">// Multi-Source Platform</span></h1>
        <div id="statusBadge" class="badge">‚ö° Chargement...</div>
    </div>

    <div class="main-grid">
        <div class="control-panel">
            <div class="dataset-config">
                <label style="font-size:0.8rem; font-weight:bold;">üîó Source de donn√©es</label>
                
                <select id="presetSelect" onchange="ui.handleSourceChange()">
                    <option value="https://raw.githubusercontent.com/mwaskom/seaborn-data/master/planets.csv" selected>ü™ê Exoplan√®tes (NASA)</option>
                    
                    <option value="https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-06-11/meteorites.csv">‚òÑÔ∏è M√©t√©orites (Toutes les chutes)</option>
                    
                    <option value="https://raw.githubusercontent.com/jbrownlee/Datasets/master/monthly-sunspots.csv">‚òÄÔ∏è Taches Solaires (1749-1983)</option>
                    
                    <option value="https://raw.githubusercontent.com/plotly/datasets/master/solar.csv">üåç Syst√®me Solaire (Simple)</option>
                    
                    <option value="https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-07-14/astronauts.csv">üßë‚ÄçüöÄ Astronautes (Missions)</option>
                    
                    <option value="custom">‚úèÔ∏è URL Personnalis√©e...</option>
                </select>

                <input type="text" id="csvUrl" style="display:none;" placeholder="https://exemple.com/data.csv">
                
                <button class="btn-sm" onclick="app.loadDataset()">üì• Charger les donn√©es</button>
                
                <div id="colsContainer" style="margin-top:5px; line-height:1.2;">
                    <span style="font-size:0.75rem; color:#8b949e;">En attente...</span>
                </div>
            </div>
            
            <div class="input-group">
                <label>ü§ñ <b>Instruction</b></label>
                <textarea id="userPrompt">Calcule la moyenne de la colonne 'mass' et trace un histogramme.</textarea>
            </div>
            
            <button id="runBtn" class="btn-primary" onclick="app.runAgent()" disabled>
                üöÄ Lancer le Pipeline
            </button>
            <div style="text-align:center; font-size:0.7rem; color:#8b949e;">Pyodide (WASM) & WebLLM (WebGPU)</div>
        </div>

        <div class="output-panel">
            <div class="tabs">
                <button class="tab active" onclick="ui.switchTab('logs')">üìã Console Ops</button>
                <button class="tab" onclick="ui.switchTab('code')">üêç Code Audit</button>
                <button class="tab" onclick="ui.switchTab('plot')">üìä Visualisation</button>
            </div>

            <div id="view-logs" class="view active">
                <div id="consoleOutput" class="console"></div>
            </div>

            <div id="view-code" class="view" style="background:#0d1117;">
                <pre><code id="codeViewer"># Le code g√©n√©r√© appara√Ætra ici...</code></pre>
            </div>

            <div id="view-plot" class="view">
                <div id="plot-target"><span style="opacity:0.5"></span></div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. CONFIG
    const CONFIG = {
        modelId: "Qwen2.5-Coder-7B-Instruct-q4f32_1-MLC"
    };
    
    let state = { 
        pyodide: null, 
        engine: null, 
        isReady: false,
        dataset: { name: "data.csv", columns: [] }
    };

    // 2. UI MANAGER
    const ui = {
        refs: {
            out: document.getElementById('consoleOutput'),
            status: document.getElementById('statusBadge'),
            btn: document.getElementById('runBtn'),
            plot: document.getElementById('plot-target'),
            code: document.getElementById('codeViewer'),
            cols: document.getElementById('colsContainer'),
            select: document.getElementById('presetSelect'),
            urlInput: document.getElementById('csvUrl')
        },
        log: (msg, type="INFO") => {
            const map = { AI: "log-ai", ERROR: "log-err", SUCCESS: "log-ok", STEP: "log-step", WARN: "log-warn", SYS: "log-sys" };
            const time = new Date().toLocaleTimeString();
            ui.refs.out.innerHTML += `<div class="${map[type] || ''}">[${time}] ${msg}</div>`;
            ui.refs.out.scrollTop = ui.refs.out.scrollHeight;
        },
        setStatus: (msg, ready=false) => {
            ui.refs.status.innerText = msg;
            if(ready) ui.refs.status.classList.add('active');
        },
        updateCols: (cols) => {
            if(!cols || cols.length === 0) return;
            ui.refs.cols.innerHTML = cols.map(c => `<span class="col-badge">${c}</span>`).join('');
        },
        // Nouvelle fonction pour g√©rer l'affichage Select/Input
        handleSourceChange: () => {
            const val = ui.refs.select.value;
            if (val === 'custom') {
                ui.refs.urlInput.style.display = 'block';
                ui.refs.urlInput.value = ""; // Reset
                ui.refs.urlInput.focus();
            } else {
                ui.refs.urlInput.style.display = 'none';
                ui.refs.urlInput.value = val; // On met l'URL du preset dans l'input cach√©
            }
        },
        switchTab: (tabName) => {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            const idx = ['logs', 'code', 'plot'].indexOf(tabName);
            if(idx > -1) document.querySelectorAll('.tab')[idx].classList.add('active');
        }
    };

    // 3. AGENT LOGIC
    const app = {
        init: async () => {
            try {
                // Initialisation UI : Mettre la valeur par d√©faut du select dans l'input
                ui.refs.urlInput.value = ui.refs.select.value;

                ui.log("Initialisation Python WASM...", "SYS");
                state.pyodide = await loadPyodide();
                await state.pyodide.loadPackage(["pandas", "matplotlib"]);

                ui.log("Chargement LLM (WebGPU)...", "SYS");
                const { MLCEngine } = window.webllm;
                state.engine = new MLCEngine();
                state.engine.setInitProgressCallback((r) => ui.setStatus(`‚è≥ ${r.text}`));
                await state.engine.reload(CONFIG.modelId);
                
                state.isReady = true;
                ui.setStatus("‚úÖ Syst√®me Pr√™t", true);
                ui.refs.btn.disabled = false;
                
                // Chargement automatique du dataset par d√©faut
                await app.loadDataset();

            } catch (e) { ui.log(`CRASH INIT: ${e.message}`, "ERROR"); }
        },

        loadDataset: async () => {
            if(!state.pyodide) return;
            
            // On r√©cup√®re l'URL (soit du preset, soit custom)
            let url = ui.refs.select.value;
            if (url === 'custom') {
                url = ui.refs.urlInput.value;
            }
            if (!url) { ui.log("‚ùå URL vide", "ERROR"); return; }

            const filename = "data.csv";
            ui.log(`üì• T√©l√©chargement...`, "SYS");
            
            try {
                const response = await fetch(url);
                if(!response.ok) throw new Error(`HTTP ${response.status}`);
                const csvText = await response.text();
                state.pyodide.FS.writeFile(filename, csvText);
                
                const colScript = `
import pandas as pd
try:
    cols = pd.read_csv('${filename}', nrows=0).columns.tolist()
    # Petit nettoyage des noms de colonnes pour √©viter les espaces
    cols = [c.strip() for c in cols]
except Exception as e:
    cols = []
cols
`;
                const pyCols = await state.pyodide.runPythonAsync(colScript);
                const colsJs = pyCols.toJs();
                
                state.dataset = { name: filename, columns: colsJs };
                ui.updateCols(colsJs);
                ui.log(`‚úÖ Donn√©es mont√©es (${colsJs.length} colonnes)`, "SUCCESS");

            } catch(e) {
                ui.log(`Echec chargement CSV: ${e.message}`, "ERROR");
            }
        },

        runAgent: async () => {
            if(!state.isReady) return;
            ui.switchTab('logs');
            ui.refs.btn.disabled = true;
            ui.refs.plot.innerHTML = '<span style="opacity:0.5">G√©n√©ration...</span>';
            
            const prompt = document.getElementById('userPrompt').value;
            const maxRetries = 3;
            let attempt = 1;

            let messages = [
                { role: "system", content: `Tu es un Data Scientist Python expert.
                  CONTEXTE DONN√âES:
                  - Le fichier est : '${state.dataset.name}'
                  - Colonnes disponibles : ${state.dataset.columns.join(', ')}
                  
                  R√àGLES DE SORTIE:
                  1. Code uniquement entre \`\`\`python ... \`\`\`.
                  2. Utilise pandas et matplotlib.
                  3. NETTOYAGE: Si besoin, convertis les colonnes en num√©rique (pd.to_numeric) et g√®re les dates (pd.to_datetime).
                  4. Pas de texte superflu.` 
                },
                { role: "user", content: prompt }
            ];

            ui.log("--- D√âMARRAGE PIPELINE ---", "STEP");

            while (attempt <= maxRetries) {
                ui.log(`üîÑ Tentative ${attempt}/${maxRetries}...`, "STEP");

                try {
                    ui.log("üß† G√©n√©ration du code...", "AI");
                    const reply = await state.engine.chat.completions.create({ messages });
                    const rawResponse = reply.choices[0].message.content;

                    let cleanCode = rawResponse;
                    const match = rawResponse.match(/```(?:python)?([\s\S]*?)```/i);
                    if (match) cleanCode = match[1].trim();

                    ui.refs.code.innerText = cleanCode;
                    ui.log("Code g√©n√©r√©.", "SYS");

                    ui.log("üõ°Ô∏è Ex√©cution Sandbox...", "SYS");
                    const result = await sandbox.execute(cleanCode);

                    if (result.success) {
                        ui.log("‚úÖ Succ√®s.", "SUCCESS");
                        if(result.output) ui.log(`STDOUT: ${result.output}`, "INFO");
                        
                        if(ui.refs.plot.innerHTML.includes('<canvas')) {
                            ui.log("üìä Graphique g√©n√©r√©.", "SUCCESS");
                            setTimeout(() => ui.switchTab('plot'), 1000);
                        }
                        break;
                    } else {
                        ui.log(`üõë Erreur: ${result.error}`, "ERROR");
                        if(attempt < maxRetries) {
                            ui.log("üîß Self-Healing activ√©...", "WARN");
                            messages.push({ role: "assistant", content: rawResponse });
                            messages.push({ role: "user", content: `Erreur Python: "${result.error}". Corrige le code.` });
                        }
                        attempt++;
                    }
                } catch (fatal) {
                    ui.log(`Fatal Error: ${fatal}`, "ERROR");
                    break;
                }
            }
            ui.refs.btn.disabled = false;
        }
    };

    // 4. SANDBOX
    const sandbox = {
        execute: async (codeToRun) => {
            const wrapper = `
import ast, sys, io, json, js
import pandas as pd
import matplotlib.pyplot as plt

plt.rcParams['toolbar'] = 'none' 
document = js.document
document.pyodideMplTarget = document.getElementById("plot-target")

def check_safety(c):
    try:
        tree = ast.parse(c)
    except SyntaxError as e: return False, f"Syntax Error: {e}"
    for n in ast.walk(tree):
        if isinstance(n, (ast.Import, ast.ImportFrom)):
            mod = n.names[0].name if isinstance(n, ast.Import) else n.module
            if mod and mod.split('.')[0] in ['os', 'sys', 'subprocess']:
                return False, f"Import interdit: {mod}"
    return True, ""

code = '''${codeToRun.replace(/'/g, "\\'")}'''
is_safe, msg = check_safety(code)
res = {}

if not is_safe:
    res = {"success": False, "error": f"Security: {msg}", "output": ""}
else:
    old = sys.stdout
    capt = io.StringIO()
    sys.stdout = capt
    try:
        plt.clf()
        exec(code)
        if plt.get_fignums(): plt.show()
        res = {"success": True, "error": "", "output": capt.getvalue()}
    except Exception as e:
        res = {"success": False, "error": str(e), "output": ""}
    finally:
        sys.stdout = old

json.dumps(res)
            `;
            try {
                const jsonStr = await state.pyodide.runPythonAsync(wrapper);
                return JSON.parse(jsonStr);
            } catch(e) {
                return { success: false, error: "Pyodide Crash: " + e.message };
            }
        }
    };

    window.addEventListener('load', app.init);
</script>

</body>
</html>